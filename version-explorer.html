<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FLUID Schema Explorer & Comparator</title>
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/open-data-protocol/fluid/main/fluid-logo.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.10/dist/cdn.min.js" defer></script>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700;800&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsondiffpatch/0.4.1/jsondiffpatch.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsondiffpatch/0.4.1/formatters-styles/html.min.css" />

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #02042B; color: #E2E8F0; }
    .font-sora { font-family: 'Sora', sans-serif; }
    .glass-card { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(12px); border-right: 1px solid rgba(56,73,106,0.5); }
    .content-tab { padding: 0.5rem 1rem; border-bottom: 2px solid transparent; transition: all 0.2s; }
    .content-tab.active { color: #38bdf8; border-bottom-color: #38bdf8; }
    .CodeMirror { height: 100%; border-radius: 0.5rem; }
    .source-bar { font-size: 0.8rem; background: #0f172a; color: #94a3b8; padding: 0.5rem 0.75rem; border-bottom: 1px solid #1e293b; }
    .source-bar code { color: #38bdf8; }
    .diff-container { padding: 1rem; overflow-y: auto; height: 100%; font-size: 0.9rem; line-height: 1.4; }

    /* Improved diff colors for better contrast and clarity */
    .jsondiffpatch-added { background: rgba(56,189,248,0.15); color: #7dd3fc; border-left: 3px solid #38bdf8; padding-left: 6px; }
    .jsondiffpatch-deleted { background: rgba(239,68,68,0.15); color: #f87171; text-decoration: line-through; border-left: 3px solid #ef4444; padding-left: 6px; }
    .jsondiffpatch-modified { background: rgba(251,191,36,0.15); color: #fcd34d; border-left: 3px solid #fbbf24; padding-left: 6px; }
  </style>
</head>
<body class="antialiased">
<main class="h-screen w-screen flex overflow-hidden" x-data="schemaExplorer()" x-init="init(); fetchSchemas()">

  <aside class="glass-card flex flex-col h-full w-64 fixed inset-y-0 left-0 transform transition-transform duration-300 z-40 md:translate-x-0"
         :class="{'-translate-x-full': !sidebarOpen, 'translate-x-0': sidebarOpen}">
    <header class="flex items-center justify-between p-4 border-b border-slate-700">
     <a href="https://open-data-protocol.github.io/fluid/"  target="_blank" class="flex items-center space-x-2 hover:opacity-80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 rounded">  
      <div class="flex items-center gap-3">
        <img src="./logo.png" alt="FLUID Logo" class="h-8 w-8" >
        <h2 class="font-sora text-xl font-bold text-slate-100" >FLUID</h2>
      </div>
    </a> 
      <button @click="sidebarOpen = false" class="md:hidden text-slate-400 hover:text-white rounded-full p-1 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-400" aria-label="Close sidebar">‚úï</button>
    </header>
    <div class="p-4 overflow-y-auto flex-1">
      <h3 class="font-sora text-lg font-bold text-slate-300 mb-2">Versions</h3>
      <p class="text-slate-400 mb-3 text-xs">Tap once to view, tap again to add/remove from comparison.</p>
      <ul class="space-y-1">
        <template x-if="loading">
          <li class="p-4 flex items-center justify-center text-slate-400">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <span>Loading...</span>
          </li>
        </template>
        <template x-for="version in versions" :key="version">
          <li>
            <button @click="toggleVersion(version)" 
                    class="w-full text-left px-3 py-2 rounded-md transition-colors duration-200 hover:bg-slate-700/70 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-800 focus-visible:ring-sky-400"
                    :class="{'bg-sky-900/70 text-sky-200': selectedVersion === version, 'ring-2 ring-pink-400': compareSelection.includes(version)}">
              v<span x-text="version"></span>
            </button>
          </li>
        </template>
      </ul>
    </div>
  </aside>

  <section class="flex-1 flex flex-col h-full overflow-hidden md:ml-64">
    
    <header class="md:hidden p-3 bg-slate-900 border-b border-slate-700 flex justify-between items-center">
      <button @click="sidebarOpen = true" class="text-sky-400 p-2 rounded-md hover:bg-slate-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-400" aria-label="Open versions sidebar">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
      </button>
      <h2 class="font-sora text-lg font-bold">Schema Explorer</h2>
    </header>

    <div class="bg-sky-900/50 text-sky-200 text-sm p-3 text-center border-b border-sky-700 sticky top-0 z-20">
      üí° Found an issue? 
      <a href="https://github.com/open-data-protocol/fluid/issues" target="_blank"
         class="underline font-bold hover:text-sky-100 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 rounded-sm">Raise an Issue directly on GitHub</a>
    </div>

    <div role="tablist" aria-label="Content views" class="p-2 border-b border-slate-700 sticky top-12 bg-slate-900/80 backdrop-blur z-20 flex space-x-2">
      <button @click="activeTab = 'docs'" class="content-tab" :class="{'active': activeTab === 'docs'}" role="tab" :aria-selected="activeTab === 'docs'" aria-controls="docs-panel">Docs</button>
      <button @click="activeTab = 'raw'" class="content-tab" :class="{'active': activeTab === 'raw'}" role="tab" :aria-selected="activeTab === 'raw'" aria-controls="raw-panel">Schema</button>
      <button @click="activeTab = 'compare'" class="content-tab" :class="{'active': activeTab === 'compare'}" role="tab" :aria-selected="activeTab === 'compare'" aria-controls="compare-panel">Compare</button>
    </div>

    <div class="flex-1 overflow-hidden flex flex-col">
      <div x-show="activeTab === 'docs'" role="tabpanel" id="docs-panel" x-transition.opacity class="flex-grow flex flex-col overflow-hidden">
        <div class="source-bar" aria-live="polite">üìñ Loaded from: <code x-text="currentSchemaUrl"></code></div>
        <iframe :src="currentSchemaUrl" class="w-full flex-grow bg-white" frameborder="0" title="Schema Documentation"></iframe>
      </div>

      <div x-show="activeTab === 'raw'" role="tabpanel" id="raw-panel" x-transition.opacity class="flex-grow flex flex-col overflow-hidden">
        <div class="source-bar flex justify-between items-center" aria-live="polite">
          <span>üì¶ Schema: <code x-text="currentSchemaJsonUrl"></code></span>
          <button @click="downloadSchema()" class="bg-sky-700 hover:bg-sky-600 text-white px-3 py-1 rounded text-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-800 focus-visible:ring-sky-400">‚¨á Download</button>
        </div>
        <div class="flex-grow overflow-hidden">
          <textarea id="code-mirror-area"></textarea>
        </div>
      </div>

      <div x-show="activeTab === 'compare'" role="tabpanel" id="compare-panel" x-transition.opacity class="flex-grow flex flex-col overflow-hidden">
        <div class="source-bar" aria-live="polite">
          üîç Diff between:
          <template x-if="compareSelection.length === 2">
            <span><code x-text="compareSelection[0]"></code> ‚áÜ <code x-text="compareSelection[1]"></code></span>
          </template>
          <template x-if="compareSelection.length !== 2">
            <span class="text-pink-400">Select 2 versions from the sidebar to compare</span>
          </template>
        </div>
        <div class="diff-container" id="diff-output">
            <div x-show="compareSelection.length !== 2" class="h-full flex flex-col items-center justify-center text-slate-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                <h3 class="text-lg font-bold text-slate-300">Select two versions</h3>
                <p>Please select two schema versions from the left sidebar to see their differences.</p>
            </div>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
function schemaExplorer() {
  return {
    versions: [],
    loading: true,
    selectedVersion: null,
    activeTab: 'docs',
    currentSchemaUrl: '',
    currentSchemaJsonUrl: '',
    currentSchemaJson: null,
    codeMirrorInstance: null,
    compareSelection: [],
    sidebarOpen: false,

    init() {
      // Initialize CodeMirror editor
      this.codeMirrorInstance = CodeMirror.fromTextArea(
        document.getElementById('code-mirror-area'),
        { mode: { name: "javascript", json: true }, theme: 'material-darker', lineNumbers: true, readOnly: true }
      );
    },

    updateCodeMirror(value) {
      if (!this.codeMirrorInstance) return;
      const formattedValue = typeof value === 'string' ? value : JSON.stringify(value, null, 2);
      this.codeMirrorInstance.setValue(formattedValue);
      // Refresh CodeMirror instance to ensure proper rendering, especially when its container was hidden.
      setTimeout(() => this.codeMirrorInstance.refresh(), 1);
    },

    async fetchSchemas() {
      try {
        // Fetch schema files from the GitHub repository API. Note: Unauthenticated requests are rate-limited.
        const response = await fetch('https://api.github.com/repos/open-data-protocol/fluid/contents/schema');
        const data = await response.json();
        
        // Parse version numbers from filenames, filter out invalid ones, and sort them numerically in descending order.
        this.versions = data
          .map(file => file.name.match(/fluid-schema-(\d+\.\d+\.\d+)\.json/)?.[1] || null)
          .filter(Boolean)
          .sort((a, b) => b.localeCompare(a, undefined, { numeric: true })); // e.g., '1.10.0' comes before '1.2.0'
        
        if (this.versions.length > 0) {
          this.selectVersion(this.versions[0]);
        }
      } catch (e) {
        console.error("Failed to fetch schemas:", e);
        // Handle UI for error state
      } finally {
        this.loading = false;
      }
    },

    async selectVersion(version) {
      this.selectedVersion = version;
      this.currentSchemaUrl = `./specs/${version}/fluid-spec.html`;
      this.currentSchemaJsonUrl = `https://raw.githubusercontent.com/open-data-protocol/fluid/main/schema/fluid-schema-${version}.json`;
      
      try {
        const res = await fetch(this.currentSchemaJsonUrl);
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const data = await res.json();
        this.currentSchemaJson = data;
        this.updateCodeMirror(data);
      } catch (err) {
        console.error(`Could not load schema for version ${version}:`, err);
        this.updateCodeMirror(`// ‚ùå Could not load schema for v${version}.\n// Please check the console for details.`);
      }
      
      if (window.innerWidth < 768) {
        this.sidebarOpen = false; // Auto-close sidebar on mobile after selection
      }
    },

    async toggleVersion(version) {
      // This function handles both single selection for viewing and dual selection for comparison.
      if (this.compareSelection.includes(version)) {
        // If already in compare list, remove it.
        this.compareSelection = this.compareSelection.filter(v => v !== version);
      } else if (this.compareSelection.length < 2) {
        // If compare list has space, add it.
        this.compareSelection.push(version);
      } else {
        // If compare list is full, replace the oldest selection with the new one.
        this.compareSelection = [this.compareSelection[1], version];
      }

      // If exactly two versions are selected, switch to compare view and run the diff.
      if (this.compareSelection.length === 2) {
        this.activeTab = 'compare';
        await this.loadComparison();
      } else {
        // Otherwise, just select the clicked version for normal viewing.
        this.selectVersion(version);
      }
    },

    async loadComparison() {
      // Sort to ensure consistent diff direction (older vs newer)
      const [v1, v2] = this.compareSelection.sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
      const url1 = `https://raw.githubusercontent.com/open-data-protocol/fluid/main/schema/fluid-schema-${v1}.json`;
      const url2 = `https://raw.githubusercontent.com/open-data-protocol/fluid/main/schema/fluid-schema-${v2}.json`;
      const diffOutput = document.getElementById("diff-output");

      try {
        const [res1, res2] = await Promise.all([fetch(url1), fetch(url2)]);
        if (!res1.ok || !res2.ok) throw new Error('Failed to fetch one or both schema files.');
        
        const [schema1, schema2] = await Promise.all([res1.json(), res2.json()]);

        const delta = jsondiffpatch.diff(schema1, schema2);
        
        if (delta) {
          diffOutput.innerHTML = jsondiffpatch.formatters.html.format(delta, schema1);
        } else {
          diffOutput.innerHTML = "<div class='p-4 text-green-400'>‚úÖ No differences found between v" + v1 + " and v" + v2 + "</div>";
        }
      } catch (err) {
        console.error("Could not load comparison:", err);
        diffOutput.innerHTML = "<div class='p-4 text-red-400'>‚ùå Could not load comparison. Please check the browser console for errors.</div>";
      }
    },

    downloadSchema() {
      if (!this.currentSchemaJson) return;
      const content = JSON.stringify(this.currentSchemaJson, null, 2);
      const blob = new Blob([content], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `fluid-schema-${this.selectedVersion}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  }
}
</script>
</body>
</html>
